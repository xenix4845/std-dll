name: Build and Release DLL

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Build DLL
        run: |
          msbuild dll.vcxproj /p:Configuration=Release /p:Platform=x64 /t:Build /p:OutDir=./bin/
          msbuild pcinfo.cpp /p:Configuration=Release /p:Platform=x64 /t:Build /p:OutDir=bin/
      
      - name: Get or create release
        id: get_release
        run: |
          RELEASE_ID=$(curl --silent "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/v1.0.0" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" | jq '.id')
          UPLOAD_URL=$(curl --silent "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/v1.0.0" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" | jq '.upload_url')
          if [ "$RELEASE_ID" == "null" ]; then
            RELEASE_RESPONSE=$(curl --silent -X POST "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d '{
                "tag_name": "v1.0.0",
                "target_commitish": "main",
                "name": "v1.0.0",
                "body": "Release v1.0.0",
                "draft": false,
                "prerelease": false
              }')
            RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq '.id')
            UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq '.upload_url')
          fi
          echo "::set-output name=release_id::$RELEASE_ID"
          echo "::set-output name=upload_url::$UPLOAD_URL"

      - name: Upload DLL
        id: upload_release_asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: ./bin/pcinfo.dll
          asset_name: pcinfo.dll
          asset_content_type: application/octet-stream